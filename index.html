<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neon Audio Visualizer — с Эквалайзером и Кастомом</title>

<!-- Подключаем шрифт из Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

<style>
:root {
  --bg: #071021;
  --panel: rgba(6,10,20,0.6);
  --accent1: #00f6ff;
  --accent2: #7c00ff;
  --bars-color-start: #00f6ff;
  --bars-color-end: #7c00ff;
  --text-color: #e6f7ff;
  --text-shadow: 0 0 12px rgba(0,246,255,0.3), 0 0 28px rgba(124,0,255,0.25);
}
* {
  box-sizing: border-box;
}
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Poppins', sans-serif, Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  color: var(--text-color);
  background: linear-gradient(180deg, #04060a 0%, var(--bg) 60%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
.app {
  width: 100%;
  max-width: 1200px;
  height: 80vh;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: 14px;
  box-shadow: 0 12px 50px rgba(2,6,23,0.7);
  display: grid;
  grid-template-columns: 1fr 360px;
  overflow: hidden;
}
.stage {
  position: relative;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
}
.bg-video {
  position: absolute;
  inset: 0;
  object-fit: cover;
  width: 100%;
  height: 100%;
  filter: brightness(0.6) saturate(1.05);
  z-index: -2;
}
.canvas-wrap {
  position: relative;
  width: 86%;
  height: 86%;
  max-width: 900px;
  max-height: 680px;
  display: flex;
  align-items: center;
  justify-content: center;
}
#outputCanvas {
  width: 100%;
  height: 100%;
  border-radius: 14px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  background: radial-gradient(circle at 30% 20%, rgba(124,0,255,0.06), transparent 8%), linear-gradient(180deg, rgba(0,0,0,0.25), transparent);
  position: relative;
  z-index: 1;
}
.circle-img {
  position: absolute;
  left: 50%;
  top: 48%;
  border-radius: 50%;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  will-change: transform;
  animation: spin 22s linear infinite;
  z-index: 2;
}
.circle-img img {
  width: 110%;
  height: 110%;
  object-fit: cover;
}
@keyframes spin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
.song-title {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18%;
  font-size: 26px;
  font-weight: 600;
  color: var(--text-color);
  text-shadow: var(--text-shadow);
  z-index: 2;
  user-select: none;
}
.bars-overlay {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 12%;
  width: 60%;
  height: 60px;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 6px;
  z-index: 2;
  pointer-events: none;
}
.bar {
  width: 6px;
  background: linear-gradient(180deg, var(--bars-color-start), var(--bars-color-end));
  box-shadow: 0 6px 18px rgba(124,0,255,0.12);
  border-radius: 3px;
  opacity: 0.8;
  transition: height 0.08s linear;
}

/* Панель справа */
.panel {
  padding: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-left: 1px solid rgba(255,255,255,0.02);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}
.h {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.logo {
  width: 44px;
  height: 44px;
  border-radius: 8px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  box-shadow: 0 8px 28px rgba(124,0,255,0.12);
}
.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  padding: 9px 12px;
  border-radius: 10px;
  color: #cfeff9;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  user-select: none;
}
.btn.primary {
  background: linear-gradient(90deg, rgba(0,246,255,0.08), rgba(124,0,255,0.06));
  border: 1px solid rgba(0,246,255,0.14);
  color: var(--accent1);
}
.input-file {
  display: none;
}
.drop {
  padding: 12px;
  border-radius: 10px;
  border: 1px dashed rgba(255,255,255,0.03);
  background: var(--panel);
  text-align: center;
  color: #9fb4c9;
  user-select: none;
}
.row {
  display: flex;
  gap: 8px;
  align-items: center;
}
label.range {
  display: flex;
  flex-direction: column;
  font-size: 13px;
  color: #9fb4c9;
}
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
}
input[type=range]::-webkit-slider-runnable-track {
  height: 6px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border-radius: 6px;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  margin-top: -5px;
}
.color-input {
  width: 100%;
  height: 32px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 4px;
}
.small {
  font-size: 13px;
  color: #9fb4c9;
}
.footer {
  margin-top: auto;
  font-size: 12px;
  color: #8ea8be;
}
.badge {
  padding: 6px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.02);
}

@media (max-width:980px) {
  .app {
    grid-template-columns: 1fr;
    height: 90vh;
  }
  .panel {
    order: 2;
    height: 40vh;
  }
  .canvas-wrap {
    width: 95%;
    height: 70%;
  }
  .circle-img {
    width: 160px !important;
    height: 160px !important;
  }
  .song-title {
    font-size: 20px;
    bottom: 14%;
  }
  .bars-overlay {
    width: 80%;
  }
}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <video id="bgVideo" class="bg-video" autoplay loop muted playsinline></video>
    <div class="canvas-wrap">
      <canvas id="outputCanvas"></canvas>
      <div class="circle-img" id="circleImg" style="width:240px; height:240px;">
        <img id="coverImage" src="" alt="cover" />
      </div>
      <div class="song-title" id="songTitle">Artist — Song</div>
      <div class="bars-overlay" id="barsOverlay"></div>
    </div>
  </div>

  <div class="panel">
    <div class="h">
      <div class="logo"></div>
      <div>
        <div style="font-weight:600">Neon Visualizer</div>
        <div class="small">Upload media, tweak and export</div>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <label class="btn">Video
          <input id="videoFile" class="input-file" type="file" accept="video/*" />
        </label>
        <button id="downloadVideoBtn" class="btn">Download original</button>
      </div>

      <div class="row">
        <label class="btn">Cover
          <input id="imageFile" class="input-file" type="file" accept="image/*" />
        </label>
        <label class="btn">Audio
          <input id="audioFile" class="input-file" type="file" accept="audio/*" />
        </label>
      </div>

      <div class="row">
        <input
          id="titleInput"
          placeholder="Artist — Song"
          style="flex:1;padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text-color);"
        />
        <button id="applyTitle" class="btn">Apply</button>
      </div>

      <div class="row">
        <label class="range" style="flex:1"
          >Bars opacity
          <input id="barsOpacity" type="range" min="0" max="1" step="0.01" value="0.7" />
        </label>
      </div>
      <div class="row">
        <label class="range" style="flex:1"
          >Circle size
          <input id="circleSize" type="range" min="120" max="360" step="1" value="240" />
        </label>
      </div>

      <div class="row">
        <label class="range" style="flex:1"
          >Bars count (bottom)
          <input id="barsCount" type="range" min="10" max="64" step="1" value="48" />
        </label>
      </div>

      <div class="row">
        <label class="range" style="flex:1"
          >Circle bars count
          <input id="circleBarsCount" type="range" min="10" max="64" step="1" value="48" />
        </label>
      </div>

      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Bars Color Start
          <input id="barsColorStart" class="color-input" type="color" value="#00f6ff" />
        </label>
      </div>
      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Bars Color End
          <input id="barsColorEnd" class="color-input" type="color" value="#7c00ff" />
        </label>
      </div>

      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Text Color
          <input id="textColor" class="color-input" type="color" value="#e6f7ff" />
        </label>
      </div>

      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Text Shadow Color
          <input id="textShadowColor" class="color-input" type="color" value="#7c00ff" />
        </label>
      </div>

      <hr />

      <div style="font-weight: 600; margin-bottom: 8px;">Audio Equalizer</div>
      <div class="row">
        <label class="range" style="flex:1"
          >Volume
          <input id="eqVolume" type="range" min="0" max="2" step="0.01" value="1" />
        </label>
      </div>
      <div class="row">
        <label class="range" style="flex:1"
          >Bass (60Hz)
          <input id="eqBass" type="range" min="-15" max="15" step="0.5" value="0" />
        </label>
      </div>
      <div class="row">
        <label class="range" style="flex:1"
          >Mid (1000Hz)
          <input id="eqMid" type="range" min="-15" max="15" step="0.5" value="0" />
        </label>
      </div>
      <div class="row">
        <label class="range" style="flex:1"
          >Treble (8000Hz)
          <input id="eqTreble" type="range" min="-15" max="15" step="0.5" value="0" />
        </label>
      </div>

      <div style="display:flex;gap:8px; margin-top: 12px;">
        <button id="recordBtn" class="btn primary">Start Recording</button>
        <button id="downloadRender" class="btn">Download Render</button>
      </div>

      <div class="drop small" id="dropzone">Drag & drop video / image / audio here</div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="presetNeon" class="btn">Preset: Neon Night</button>
        <button id="presetCalm" class="btn">Preset: Calm</button>
      </div>

      <div class="footer">
        Shortcuts: Space = Play/Pause audio (if loaded) • R = record • S = screenshot
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  const bgVideo = document.getElementById('bgVideo');
  const videoFile = document.getElementById('videoFile');
  const imageFile = document.getElementById('imageFile');
  const audioFile = document.getElementById('audioFile');
  const coverImage = document.getElementById('coverImage');
  const circleImg = document.getElementById('circleImg');
  const titleInput = document.getElementById('titleInput');
  const applyTitle = document.getElementById('applyTitle');
  const songTitle = document.getElementById('songTitle');
  const outputCanvas = document.getElementById('outputCanvas');
  const ctx = outputCanvas.getContext('2d');
  const barsOverlay = document.getElementById('barsOverlay');
  const barsOpacity = document.getElementById('barsOpacity');
  const circleSize = document.getElementById('circleSize');
  const barsCountInput = document.getElementById('barsCount');
  const circleBarsCountInput = document.getElementById('circleBarsCount');
  const barsColorStart = document.getElementById('barsColorStart');
  const barsColorEnd = document.getElementById('barsColorEnd');
  const textColorInput = document.getElementById('textColor');
  const textShadowColorInput = document.getElementById('textShadowColor');
  const dropzone = document.getElementById('dropzone');
  const recordBtn = document.getElementById('recordBtn');
  const downloadRender = document.getElementById('downloadRender');
  const downloadVideoBtn = document.getElementById('downloadVideoBtn');

  // Audio equalizer controls
  const eqVolume = document.getElementById('eqVolume');
  const eqBass = document.getElementById('eqBass');
  const eqMid = document.getElementById('eqMid');
  const eqTreble = document.getElementById('eqTreble');

  let audioEl = null;
  let audioCtx = null;
  let analyser = null;
  let dataArray = null;
  let sourceNode = null;
  let gainNode = null;
  let bassFilter = null;
  let midFilter = null;
  let trebleFilter = null;
  let raf;
  let circleDiameter = parseInt(circleSize.value);
  let barsCount = parseInt(barsCountInput.value);
  let circleBarsCount = parseInt(circleBarsCountInput.value);
  let barsEls = [];

  // Set initial sizes
  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    outputCanvas.width = outputCanvas.clientWidth * dpr;
    outputCanvas.height = outputCanvas.clientHeight * dpr;
  }
  resizeCanvas();
  window.addEventListener('resize', () => {
    resizeCanvas();
  });

  // Setup bars overlay with barsCount bars
  function createBars() {
    barsOverlay.innerHTML = '';
    barsEls = [];
    for(let i = 0; i < barsCount; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      barsOverlay.appendChild(bar);
      barsEls.push(bar);
    }
  }
  createBars();

  // Load video to bg video element
  videoFile.addEventListener('change', () => {
    const file = videoFile.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    bgVideo.src = url;
    bgVideo.play();
    downloadVideoBtn.disabled = false;
    downloadVideoBtn.dataset.url = url;
  });

  downloadVideoBtn.addEventListener('click', () => {
    const url = downloadVideoBtn.dataset.url;
    if (url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'background-video.' + (url.split('.').pop() || 'mp4');
      a.click();
    }
  });

  // Load image cover
  imageFile.addEventListener('change', () => {
    const file = imageFile.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    coverImage.src = url;
  });

  // Audio loading and setup audio context & nodes
  audioFile.addEventListener('change', () => {
    const file = audioFile.files[0];
    if (!file) return;

    if(audioEl){
      audioEl.pause();
      audioEl = null;
      if(audioCtx) {
        audioCtx.close();
        audioCtx = null;
      }
    }

    audioEl = new Audio(URL.createObjectURL(file));
    audioEl.loop = true;
    audioEl.crossOrigin = "anonymous";
    audioEl.play();

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audioEl);

    gainNode = audioCtx.createGain();
    bassFilter = audioCtx.createBiquadFilter();
    bassFilter.type = "lowshelf";
    bassFilter.frequency.value = 60;
    bassFilter.gain.value = 0;

    midFilter = audioCtx.createBiquadFilter();
    midFilter.type = "peaking";
    midFilter.frequency.value = 1000;
    midFilter.Q.value = 1;
    midFilter.gain.value = 0;

    trebleFilter = audioCtx.createBiquadFilter();
    trebleFilter.type = "highshelf";
    trebleFilter.frequency.value = 8000;
    trebleFilter.gain.value = 0;

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    sourceNode.connect(bassFilter);
    bassFilter.connect(midFilter);
    midFilter.connect(trebleFilter);
    trebleFilter.connect(gainNode);
    gainNode.connect(analyser);
    analyser.connect(audioCtx.destination);

    draw();
  });

  // Apply title text
  applyTitle.addEventListener('click', () => {
    songTitle.textContent = titleInput.value || "Artist — Song";
  });

  // Sync text color inputs to CSS variables
  function updateTextColors() {
    const c = textColorInput.value;
    const shadowC = textShadowColorInput.value;
    songTitle.style.color = c;
    songTitle.style.textShadow = `0 0 12px ${c}80, 0 0 28px ${shadowC}60`;
  }
  textColorInput.addEventListener('input', updateTextColors);
  textShadowColorInput.addEventListener('input', updateTextColors);
  updateTextColors();

  // Update bars opacity CSS var
  barsOpacity.addEventListener('input', () => {
    document.documentElement.style.setProperty('--bars-opacity', barsOpacity.value);
  });
  barsOpacity.dispatchEvent(new Event('input'));

  // Circle size control (circle & image & redraw)
  circleSize.addEventListener('input', () => {
    circleDiameter = parseInt(circleSize.value);
    circleImg.style.width = circleDiameter + 'px';
    circleImg.style.height = circleDiameter + 'px';
  });
  circleSize.dispatchEvent(new Event('input'));

  // Bars count bottom
  barsCountInput.addEventListener('input', () => {
    barsCount = parseInt(barsCountInput.value);
    createBars();
  });
  barsCountInput.dispatchEvent(new Event('input'));

  // Circle bars count
  circleBarsCountInput.addEventListener('input', () => {
    circleBarsCount = parseInt(circleBarsCountInput.value);
  });
  circleBarsCountInput.dispatchEvent(new Event('input'));

  // Bars colors
  function updateBarsColors() {
    document.documentElement.style.setProperty('--bars-color-start', barsColorStart.value);
    document.documentElement.style.setProperty('--bars-color-end', barsColorEnd.value);
  }
  barsColorStart.addEventListener('input', updateBarsColors);
  barsColorEnd.addEventListener('input', updateBarsColors);
  updateBarsColors();

  // Audio equalizer control handlers
  eqVolume.addEventListener('input', () => {
    if(gainNode) gainNode.gain.value = eqVolume.value;
  });
  eqBass.addEventListener('input', () => {
    if(bassFilter) bassFilter.gain.value = eqBass.value;
  });
  eqMid.addEventListener('input', () => {
    if(midFilter) midFilter.gain.value = eqMid.value;
  });
  eqTreble.addEventListener('input', () => {
    if(trebleFilter) trebleFilter.gain.value = eqTreble.value;
  });

  // Visualizer draw loop
  function draw() {
    if (!analyser || !dataArray) return;

    analyser.getByteFrequencyData(dataArray);
    ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);

    const w = outputCanvas.width;
    const h = outputCanvas.height;
    const centerX = w / 2;
    const centerY = h / 2;
    const radius = circleDiameter / 2 + 12;

    // Draw circle bars
    const angleStep = (2 * Math.PI) / circleBarsCount;
    for (let i = 0; i < circleBarsCount; i++) {
      const val = dataArray[i] || 0;
      const barLength = val / 2;
      const angle = angleStep * i - Math.PI / 2;

      const xStart = centerX + Math.cos(angle) * radius;
      const yStart = centerY + Math.sin(angle) * radius;
      const xEnd = centerX + Math.cos(angle) * (radius + barLength);
      const yEnd = centerY + Math.sin(angle) * (radius + barLength);

      const grad = ctx.createLinearGradient(xStart, yStart, xEnd, yEnd);
      grad.addColorStop(0, barsColorStart.value);
      grad.addColorStop(1, barsColorEnd.value);

      ctx.strokeStyle = grad;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(xStart, yStart);
      ctx.lineTo(xEnd, yEnd);
      ctx.stroke();
    }

    // Draw bars overlay (bottom)
    for (let i = 0; i < barsEls.length; i++) {
      const val = dataArray[i] || 0;
      barsEls[i].style.height = `${val / 2 + 6}px`;
      barsEls[i].style.opacity = barsOpacity.value;
      barsEls[i].style.background = `linear-gradient(180deg, ${barsColorStart.value}, ${barsColorEnd.value})`;
      barsEls[i].style.boxShadow = `0 6px 18px ${barsColorEnd.value}80`;
    }

    raf = requestAnimationFrame(draw);
  }

  // Drag & drop support
  ['dragenter', 'dragover'].forEach(ev => {
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = barsColorStart.value;
    });
  });
  ['dragleave', 'drop'].forEach(ev => {
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = '';
    });
  });
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    if (e.dataTransfer.files.length === 0) return;
    for (const file of e.dataTransfer.files) {
      if (file.type.startsWith('video/')) {
        videoFile.files = e.dataTransfer.files;
        const event = new Event('change');
        videoFile.dispatchEvent(event);
      } else if (file.type.startsWith('image/')) {
        imageFile.files = e.dataTransfer.files;
        const event = new Event('change');
        imageFile.dispatchEvent(event);
      } else if (file.type.startsWith('audio/')) {
        audioFile.files = e.dataTransfer.files;
        const event = new Event('change');
        audioFile.dispatchEvent(event);
      }
    }
  });

  // Recording setup
  let recorder = null;
  let recordedChunks = [];
  recordBtn.addEventListener('click', () => {
    if (recorder && recorder.state === 'recording') {
      recorder.stop();
      recordBtn.textContent = 'Start Recording';
      return;
    }
    recordedChunks = [];
    let stream = outputCanvas.captureStream(30);
    if (audioCtx && audioEl && !audioEl.paused) {
      const audioStreamDest = audioCtx.createMediaStreamDestination();
      sourceNode.connect(audioStreamDest);
      stream.addTrack(audioStreamDest.stream.getAudioTracks()[0]);
    }

    recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
    recorder.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };
    recorder.onstop = e => {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'visualizer.webm';
      a.click();
      URL.revokeObjectURL(url);
    };
    recorder.start();
    recordBtn.textContent = 'Stop Recording';
  });

  // Download canvas render as PNG
  downloadRender.addEventListener('click', () => {
    outputCanvas.toBlob(blob => {
      const a = document.createElement('a');
      a.download = 'visualizer.png';
      a.href = URL.createObjectURL(blob);
      a.click();
    });
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', e => {
    if (!audioEl) return;
    if (e.code === 'Space') {
      e.preventDefault();
      if (audioEl.paused) audioEl.play();
      else audioEl.pause();
    }
    if (e.code === 'KeyR') {
      recordBtn.click();
    }
    if (e.code === 'KeyS') {
      downloadRender.click();
    }
  });

  // Initialize with some default text
  songTitle.textContent = "Artist — Song";

})();
</script>
</body>
</html>
