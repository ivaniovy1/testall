<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Neon Audio Visualizer — Улучшенный</title>
<style>
:root {
  --bg: #071021;
  --panel: rgba(6,10,20,0.6);
  --accent1: #00f6ff;
  --accent2: #7c00ff;
  --glass: rgba(255,255,255,0.04);
  --bars-color-start: #00f6ff;
  --bars-color-end: #7c00ff;
}
* {
  box-sizing: border-box;
}
html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  color: #e6f7ff;
  background: linear-gradient(180deg, #04060a 0%, var(--bg) 60%);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
}
.app {
  width: 100%;
  max-width: 1200px;
  height: 80vh;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius: 14px;
  box-shadow: 0 12px 50px rgba(2,6,23,0.7);
  display: grid;
  grid-template-columns: 1fr 360px;
  overflow: hidden;
}
.stage {
  position: relative;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
}
.bg-video {
  position: absolute;
  inset: 0;
  object-fit: cover;
  width: 100%;
  height: 100%;
  filter: brightness(0.6) saturate(1.05);
  z-index: -2;
}
.canvas-wrap {
  position: relative;
  width: 86%;
  height: 86%;
  max-width: 900px;
  max-height: 680px;
  display: flex;
  align-items: center;
  justify-content: center;
}
#outputCanvas {
  width: 100%;
  height: 100%;
  border-radius: 14px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  background: radial-gradient(circle at 30% 20%, rgba(124,0,255,0.06), transparent 8%), linear-gradient(180deg, rgba(0,0,0,0.25), transparent);
  position: relative;
  z-index: 1;
}
.circle-img {
  position: absolute;
  left: 50%;
  top: 48%;
  border-radius: 50%;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
  will-change: transform;
  animation: spin 22s linear infinite;
  z-index: 2;
}
.circle-img img {
  width: 110%;
  height: 110%;
  object-fit: cover;
}
@keyframes spin {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
.song-title {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 18%;
  font-size: 26px;
  font-weight: 600;
  text-shadow: 0 0 12px rgba(0,246,255,0.08), 0 0 28px rgba(124,0,255,0.06);
  z-index: 2;
  user-select: none;
}
.bars-overlay {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 12%;
  width: 60%;
  height: 60px;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 6px;
  z-index: 2;
  pointer-events: none;
}
.bar {
  width: 6px;
  background: linear-gradient(180deg, var(--bars-color-start), var(--bars-color-end));
  box-shadow: 0 6px 18px rgba(124,0,255,0.12);
  border-radius: 3px;
  opacity: 0.8;
  transition: height 0.08s linear;
}

/* Right panel */
.panel {
  padding: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-left: 1px solid rgba(255,255,255,0.02);
  display: flex;
  flex-direction: column;
}
.h {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.logo {
  width: 44px;
  height: 44px;
  border-radius: 8px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  box-shadow: 0 8px 28px rgba(124,0,255,0.12);
}
.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.btn {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  padding: 9px 12px;
  border-radius: 10px;
  color: #cfeff9;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  user-select: none;
}
.btn.primary {
  background: linear-gradient(90deg, rgba(0,246,255,0.08), rgba(124,0,255,0.06));
  border: 1px solid rgba(0,246,255,0.14);
  color: var(--accent1);
}
.input-file {
  display: none;
}
.drop {
  padding: 12px;
  border-radius: 10px;
  border: 1px dashed rgba(255,255,255,0.03);
  background: var(--panel);
  text-align: center;
  color: #9fb4c9;
  user-select: none;
}
.row {
  display: flex;
  gap: 8px;
  align-items: center;
}
label.range {
  display: flex;
  flex-direction: column;
  font-size: 13px;
  color: #9fb4c9;
}
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
}
input[type=range]::-webkit-slider-runnable-track {
  height: 6px;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  border-radius: 6px;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  margin-top: -5px;
}
.small {
  font-size: 13px;
  color: #9fb4c9;
}
.footer {
  margin-top: auto;
  font-size: 12px;
  color: #8ea8be;
}
.badge {
  padding: 6px 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.02);
}

@media (max-width:980px) {
  .app {
    grid-template-columns: 1fr;
    height: 90vh;
  }
  .panel {
    order: 2;
    height: 40vh;
    overflow: auto;
  }
  .canvas-wrap {
    width: 95%;
    height: 70%;
  }
  .circle-img {
    width: 160px !important;
    height: 160px !important;
  }
  .song-title {
    font-size: 20px;
    bottom: 14%;
  }
  .bars-overlay {
    width: 80%;
  }
}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <video id="bgVideo" class="bg-video" autoplay loop muted playsinline></video>
    <div class="canvas-wrap">
      <canvas id="outputCanvas"></canvas>
      <div class="circle-img" id="circleImg" style="width:240px; height:240px;">
        <img id="coverImage" src="" alt="cover" />
      </div>
      <div class="song-title" id="songTitle">Artist — Song</div>
      <div class="bars-overlay" id="barsOverlay"></div>
    </div>
  </div>

  <div class="panel">
    <div class="h">
      <div class="logo"></div>
      <div>
        <div style="font-weight:600">Neon Visualizer</div>
        <div class="small">Upload media, tweak and export</div>
      </div>
    </div>
    <div class="controls">
      <div class="row">
        <label class="btn">Video
          <input id="videoFile" class="input-file" type="file" accept="video/*" />
        </label>
        <button id="downloadVideoBtn" class="btn">Download original</button>
      </div>

      <div class="row">
        <label class="btn">Cover
          <input id="imageFile" class="input-file" type="file" accept="image/*" />
        </label>
        <label class="btn">Audio
          <input id="audioFile" class="input-file" type="file" accept="audio/*" />
        </label>
      </div>

      <div class="row">
        <input
          id="titleInput"
          placeholder="Artist — Song"
          style="flex:1;padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6f7ff"
        />
        <button id="applyTitle" class="btn">Apply</button>
      </div>

      <div class="row">
        <label class="range" style="flex:1"
          >Bars opacity
          <input id="barsOpacity" type="range" min="0" max="1" step="0.01" value="0.7" />
        </label>
      </div>
      <div class="row">
        <label class="range" style="flex:1"
          >Circle size
          <input id="circleSize" type="range" min="120" max="360" step="1" value="240" />
        </label>
      </div>

      <div class="row">
        <label class="range" style="flex:1"
          >Bars count
          <input id="barsCount" type="range" min="10" max="64" step="1" value="48" />
        </label>
      </div>

      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Bars Color Start
          <input id="barsColorStart" type="color" value="#00f6ff" />
        </label>
      </div>
      <div class="row">
        <label style="flex:1;display:flex;flex-direction:column;gap:6px">
          Bars Color End
          <input id="barsColorEnd" type="color" value="#7c00ff" />
        </label>
      </div>

      <div style="display:flex;gap:8px">
        <button id="recordBtn" class="btn primary">Start Recording</button>
        <button id="downloadRender" class="btn">Download Render</button>
      </div>

      <div class="drop small" id="dropzone">Drag & drop video / image / audio here</div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="presetNeon" class="btn">Preset: Neon Night</button>
        <button id="presetCalm" class="btn">Preset: Calm</button>
      </div>

      <div class="footer">
        Shortcuts: Space = Play/Pause audio (if loaded) • R = record • S = screenshot
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  // Elements
  const bgVideo = document.getElementById('bgVideo');
  const videoFile = document.getElementById('videoFile');
  const imageFile = document.getElementById('imageFile');
  const audioFile = document.getElementById('audioFile');
  const coverImage = document.getElementById('coverImage');
  const circleImg = document.getElementById('circleImg');
  const titleInput = document.getElementById('titleInput');
  const applyTitle = document.getElementById('applyTitle');
  const songTitle = document.getElementById('songTitle');
  const outputCanvas = document.getElementById('outputCanvas');
  const ctx = outputCanvas.getContext('2d');
  const barsOverlay = document.getElementById('barsOverlay');
  const barsOpacity = document.getElementById('barsOpacity');
  const circleSize = document.getElementById('circleSize');
  const barsCountInput = document.getElementById('barsCount');
  const barsColorStart = document.getElementById('barsColorStart');
  const barsColorEnd = document.getElementById('barsColorEnd');
  const dropzone = document.getElementById('dropzone');
  const recordBtn = document.getElementById('recordBtn');
  const downloadRender = document.getElementById('downloadRender');
  const downloadVideoBtn = document.getElementById('downloadVideoBtn');

  // State
  let audioEl = null;
  let audioCtx = null;
  let analyser = null;
  let dataArray = null;
  let sourceNode = null;
  let raf;
  let circleDiameter = parseInt(circleSize.value);
  let barsCount = parseInt(barsCountInput.value);
  let barsEls = [];

  // Canvas sizing
  function resize() {
    const rect = outputCanvas.getBoundingClientRect();
    outputCanvas.width = rect.width * devicePixelRatio;
    outputCanvas.height = rect.height * devicePixelRatio;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(devicePixelRatio, devicePixelRatio);
  }
  window.addEventListener('resize', () => {
    resize();
    createBars();
  });
  resize();

  // Create bars DOM elements for overlay (under text)
  function createBars() {
    barsOverlay.innerHTML = '';
    barsEls = [];
    barsCount = parseInt(barsCountInput.value);
    for (let i = 0; i < barsCount; i++) {
      const b = document.createElement('div');
      b.className = 'bar';
      b.style.height = '6px';
      b.style.opacity = barsOpacity.value;
      b.style.transition = 'height 0.08s linear';
      barsOverlay.appendChild(b);
      barsEls.push(b);
    }
  }
  createBars();

  // Load files
  function loadVideoFile(file) {
    if (!file) return;
    const url = URL.createObjectURL(file);
    bgVideo.src = url;
    bgVideo.play();
    // prepare download
    downloadVideoBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name || 'video.mp4';
      a.click();
    };
  }
  function loadImageFile(file) {
    if (!file) return;
    coverImage.src = URL.createObjectURL(file);
  }
  async function loadAudioFile(file) {
    if (!file) return;
    if (audioEl) {
      audioEl.pause();
      audioEl.src = '';
    }
    audioEl = new Audio(URL.createObjectURL(file));
    audioEl.loop = true;
    await audioEl.play();
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (sourceNode) try {
      sourceNode.disconnect();
    } catch (e) { }
    sourceNode = audioCtx.createMediaElementSource(audioEl);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    sourceNode.connect(analyser);
    const destination = audioCtx.destination;
    sourceNode.connect(destination);
    try { await audioCtx.resume(); } catch (e) { }
  }

  videoFile.addEventListener('change', e => loadVideoFile(e.target.files[0]));
  imageFile.addEventListener('change', e => loadImageFile(e.target.files[0]));
  audioFile.addEventListener('change', e => loadAudioFile(e.target.files[0]));
  applyTitle.addEventListener('click', () => {
    songTitle.textContent = titleInput.value || 'Artist — Song';
  });

  circleSize.addEventListener('input', () => {
    circleDiameter = parseInt(circleSize.value);
    circleImg.style.width = circleDiameter + 'px';
    circleImg.style.height = circleDiameter + 'px';
  });
  barsOpacity.addEventListener('input', () => {
    const v = barsOpacity.value;
    barsEls.forEach(b => b.style.opacity = v);
  });
  barsCountInput.addEventListener('input', () => {
    createBars();
  });
  barsColorStart.addEventListener('input', () => {
    document.documentElement.style.setProperty('--bars-color-start', barsColorStart.value);
  });
  barsColorEnd.addEventListener('input', () => {
    document.documentElement.style.setProperty('--bars-color-end', barsColorEnd.value);
  });

  // Drag & drop support
  ['dragenter', 'dragover'].forEach(ev => {
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = 'rgba(0,246,255,0.2)';
    });
  });
  ['dragleave', 'drop'].forEach(ev => {
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = '';
    });
  });
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    if (e.dataTransfer.files.length === 0) return;
    for (const file of e.dataTransfer.files) {
      if (file.type.startsWith('video/')) {
        videoFile.files = e.dataTransfer.files;
        loadVideoFile(file);
      } else if (file.type.startsWith('image/')) {
        imageFile.files = e.dataTransfer.files;
        loadImageFile(file);
      } else if (file.type.startsWith('audio/')) {
        audioFile.files = e.dataTransfer.files;
        loadAudioFile(file);
      }
    }
  });

  // Draw loop for circle visualizer & bars update
  function draw() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);

    // Get canvas size
    const w = outputCanvas.width / devicePixelRatio;
    const h = outputCanvas.height / devicePixelRatio;

    // Draw circle visualizer around circle image center
    const centerX = w / 2;
    const centerY = h / 2;
    const radius = circleDiameter / 2 + 16;

    const barsCountCircle = 48; // fixed for circle visualizer
    const angleStep = (2 * Math.PI) / barsCountCircle;

    for (let i = 0; i < barsCountCircle; i++) {
      const val = dataArray[i];
      const barLength = val / 2;
      const angle = angleStep * i - Math.PI / 2;

      const xStart = centerX + Math.cos(angle) * radius;
      const yStart = centerY + Math.sin(angle) * radius;
      const xEnd = centerX + Math.cos(angle) * (radius + barLength);
      const yEnd = centerY + Math.sin(angle) * (radius + barLength);

      ctx.strokeStyle = `hsl(${(i * 360) / barsCountCircle}, 100%, 70%)`;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(xStart, yStart);
      ctx.lineTo(xEnd, yEnd);
      ctx.stroke();
    }

    // Update bars below text
    for (let i = 0; i < barsEls.length; i++) {
      const val = dataArray[i] || 0;
      barsEls[i].style.height = `${val / 2 + 6}px`;
    }

    requestAnimationFrame(draw);
  }

  // Start the animation loop only when audio is loaded
  function startVisualizer() {
    if (!audioEl) return;
    if (!analyser) return;
    cancelAnimationFrame(raf);
    draw();
  }

  // Keyboard shortcuts
  window.addEventListener('keydown', e => {
    if (!audioEl) return;
    if (e.code === 'Space') {
      e.preventDefault();
      if (audioEl.paused) audioEl.play();
      else audioEl.pause();
    }
    if (e.code === 'KeyR') {
      recordBtn.click();
    }
    if (e.code === 'KeyS') {
      downloadRender.click();
    }
  });

  // Recording setup
  let recorder = null;
  let recordedChunks = [];
  recordBtn.addEventListener('click', () => {
    if (recorder && recorder.state === 'recording') {
      recorder.stop();
      recordBtn.textContent = 'Start Recording';
      return;
    }

    recordedChunks = [];
    let stream = outputCanvas.captureStream(30);
    if (audioEl && !audioEl.paused) {
      const audioStream = audioCtx.createMediaStreamDestination();
      sourceNode.connect(audioStream);
      stream.addTrack(audioStream.stream.getAudioTracks()[0]);
    }

    recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
    recorder.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };
    recorder.onstop = e => {
      const blob = new Blob(recordedChunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'visualizer.webm';
      a.click();
      URL.revokeObjectURL(url);
    };
    recorder.start();
    recordBtn.textContent = 'Stop Recording';
  });

  // Screenshot export
  downloadRender.addEventListener('click', () => {
    outputCanvas.toBlob(blob => {
      const a = document.createElement('a');
      a.download = 'visualizer.png';
      a.href = URL.createObjectURL(blob);
      a.click();
    });
  });

  // Auto-start visualizer when audio loaded
  audioFile.addEventListener('change', () => {
    setTimeout(startVisualizer, 300);
  });

  // Auto resize and circle size init
  circleSize.dispatchEvent(new Event('input'));

  // Presets
  document.getElementById('presetNeon').addEventListener('click', () => {
    barsColorStart.value = '#00f6ff';
    barsColorEnd.value = '#7c00ff';
    barsOpacity.value = 0.7;
    barsCountInput.value = 48;
    circleSize.value = 240;
    barsColorStart.dispatchEvent(new Event('input'));
    barsColorEnd.dispatchEvent(new Event('input'));
    barsOpacity.dispatchEvent(new Event('input'));
    barsCountInput.dispatchEvent(new Event('input'));
    circleSize.dispatchEvent(new Event('input'));
  });
  document.getElementById('presetCalm').addEventListener('click', () => {
    barsColorStart.value = '#7c7cff';
    barsColorEnd.value = '#00ffff';
    barsOpacity.value = 0.3;
    barsCountInput.value = 28;
    circleSize.value = 180;
    barsColorStart.dispatchEvent(new Event('input'));
    barsColorEnd.dispatchEvent(new Event('input'));
    barsOpacity.dispatchEvent(new Event('input'));
    barsCountInput.dispatchEvent(new Event('input'));
    circleSize.dispatchEvent(new Event('input'));
  });
})();
</script>
</body>
</html>
